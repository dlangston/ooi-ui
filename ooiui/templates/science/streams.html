{% extends "common/base.html" %}

{% block title %}
    <title>Data Catalog</title>
{% endblock %}

{% block head %}

  <link href="/css/compiled/index.css" rel="stylesheet" type="text/css" />
  <!-- partials -->
  <script src="/js/partials/compiled/index.js" type="text/javascript"></script>
  <script src="/js/partials/compiled/svgplot.js" type="text/javascript"></script>
  <!-- lunr needs to be imported by a script tag -->
  <script src="/lib/lunr.js/lunr.js" type="text/javascript"></script>
  <script src="/js/compiled/index.js" type="text/javascript"></script>
  
  <script src="/js/compiled/svgplot.js" type="text/javascript"></script>
{% endblock %}

{%block body %}    
<div class="container-fluid">
  <div id="navbar" class="row"></div>
</div>

<div id="wrapper">
  <div id="sidebar-wrapper" class="hidden navbar-default">
  </div> 
  <!-- #sidebar-wrapper -->
  <div id="page-content-wrapper">
      <div class="content-fluid">
          <div class="row">
              <div class="col-sm-12">
                  <div class="panel">
                      <div class="panel-heading">
                          <span class="glyphicon glyphicon-hdd" aria-hidden="true"> Data Catalog</span>
                          <div class="panel-search pull-right">
                              <input id='stream-search' type="text" placeholder="&#xf002; Search">
                              <span id="search-clear" class="glyphicon glyphicon-remove-circle"></span>
                          </div>
                      </div>
                      <div class="panel-body">
                          <div id="stream-table-view">
                              <table  class="table table-bordered table-striped table-selectable">
                                  <i  class="fa fa-spinner fa-spin" style="margin-left:50%;font-size:90px;"> </i>
                                  <thead>
                                  </thead>
                              </table>
                          </div> <!-- #view -->
                      </div> <!-- .panel-body -->
                  </div> <!-- .panel -->
              </div> <!-- .col -->
          </div> <!-- .row -->
          <div class="paginator row text-center">
              <div class="pagination-info"> </div>
              <div class="pagination pagination-right pagination-boxes"></div>
          </div>
    </div> <!-- .content-fluid -->
    <div id="stream-download-modal">
    </div>
    <div id='download-ok-modal'></div>
    <div id='download-fail-modal'></div>
  </div> <!-- #page-content-wrapper -->
</div> <!-- #wrapper -->


<script type="text/javascript">

var userId = parseInt(window.location.href.split('/').pop());

_.extend(OOI.prototype, Backbone.Events, {
  login: new LoginModel(),
  collections: {
    streams: new StreamCollection()
  },
  views: {
  },
  models: {
    userModel: new UserModel()
  },
  start: function() {
    var self = this;
    this.login.fetch({async: false});

    this.views.banner = new BannerView();
    $('body').prepend(this.views.banner.el);
    
    this.views.navbar = new NavbarView({
        el: $('#navbar')
    });
 
    if(this.login.loggedIn()) {
      this.models.userModel.fetch({url: '/api/current_user'});
    }

    this.views.navbar = new NavbarView();
    $('body').prepend(this.views.navbar.el);
    this.views.navbar.sidebarToggle();

    this.views.streamTableView = new StreamTableView({
      collection: this.collections.streams,
      el: $('#stream-table-view')
    });

    this.views.streamDownloadFormView = new StreamDownloadFormView({
      el: $('#stream-download-modal')
    });
    this.views.modalDownloadView = new ModalDownloadView({
      el: $('#download-ok-modal')
      });
    this.views.modalDownloadFailView = new ModalDownloadFailView({
      el: $('#download-fail-modal')
      });


    // Get the list of streams from the API
    updateCollection( showStreams );

    // When the custom event fires, update the pagination
    collection.on("collection:updated", function( details ){
        updatePagination( details, showStreams );
        });
    
    //this.collections.streams.fetch({reset:true});

    /* Dispatcher Section */
    this.listenTo(this, "login:success", function() { location.reload(); });
    this.listenTo(this, "login:logout", function() { location.reload(); });
    this.listenTo(this, 'StreamTableItemView:onRowClick', function(row) {

        row.focus();

      //get the model
      var ref_des = row.model.get('reference_designator')
      var ref_des_split = ref_des.split("-")
      //get the current location
      if (!location.origin)
        location.origin = location.protocol + "//" + location.host;

      //get the parts
      var array = ref_des.substring(0, 2);
      var mooring = ref_des_split[0]
      var platform = ref_des_split[1]
      var instrument = ref_des
      var instrument_url = [array, mooring, platform , instrument].join("/");

      var win = window.open(location.origin+"/plotting/"+instrument_url, '_blank');
      win.focus();


    });

    this.listenTo(this, 'StreamTableItemView:onClick', function(options) {
      var base_url = window.location.protocol+"//"+window.location.host+"/"
      var download_link = options.model.get('download');
      var download_link_url = download_link[options['selection']]

      base_url+=download_link_url+"/"+options.model.get('start')+"/"+ options.model.get('end')

      self.views.streamDownloadFormView.show(options);
      console.log(options)
      //window.open(base_url, '_blank');

    });
    this.listenTo(this, 'DownloadModal:onHide',function(){
        self.views.modalDownloadView.show();
  });
    this.listenTo(this, 'DownloadModalFail:onFail',function(){
        self.views.modalDownloadFailView.show();
  });

}
});

var ooi = new OOI();
var collection = new StreamCollection();

// The pagination object holds information about the current
// state of the page for us.
var pagination = {
    itemsPerPage : 20, // how many items per page
    currentPage : 1, // page to start at, first page is 1, not 0
    maxPages: 10 // max number of pages to show in the pagination element
}

$(document).ready(function() {
        ooi.start();
        $('body').find('#search-clear').hide();
        $("#search-clear").click(function(){
            $("#stream-search").val('').focus();
            $(this).hide();
            updateCollection( showStreams )
            });

        $('#stream-search').keyup(function(e) {
                $("#search-clear").toggle(Boolean($(this).val()));
                $("#search-clear").toggle(Boolean($("#stream-search").val()));
                updateCollection( showStreams )
            });
        $('body').find('#hideTOC').hide()
});

function jump(h){
    var url = location.href;               //Save down the URL without hash.
    location.href = "#"+h;                 //Go to the target element.
    history.replaceState(null,null,url);   //Don't like hashes. Changing it back.
}

function showStreams( collection, response ){

    var streamTableView = new StreamTableView({
        collection: collection
    });

    streamTableView.render();

// Empty the table and append the new results.
        $(".table").find("tbody").remove().end();
        $(".fa-spinner").remove();
        $(".table").append( streamTableView.el );
    }

function updateCollection( successCallback ){

    // If there is a search term, we need to set the startAt attribute to 0,
    // otherwise the results may not load on the page.
    var startingPoint = "";
    if ($('#stream-search').is(':focus')) {
        startingPoint = 0;
    } else {
        startingPoint = ( pagination.currentPage - 1) *  pagination.itemsPerPage;
    }
    // Pagination attributes will be passed in using
    // backbone's collection data method.
    var data = {
        startAt : startingPoint,
        count : pagination.itemsPerPage,
        search : $('#stream-search').val()
    };

    collection.fetch({
        data : data,
        success : successCallback,
    //    error : showError
    });
}

function updatePagination( details, successCallback ){

    // Calculate pagination attributes
    var start = details.startAt + 1,
        end = details.startAt + details.count,
        totalPages = Math.ceil( details.total / pagination.itemsPerPage ),
        currentPage = details.startAt / details.count + 1;

    // Display a "Page 1 of 5" type message on the page
    if (end >= details.total) {
        $(".pagination-info").text("Showing records " + start + " through " + details.total + " of " + details.total );
    } else {
        $(".pagination-info").text("Showing records " + start + " through " + end + " of " + details.total );
    }
    // Remove the pagination binding so they don't get called
    // multiple times after they're redrawn.
    $(".pagination-boxes").unbind();

    // Redraw the jquery pagination boxes
    $(".pagination-boxes").pagination({
        total_pages: totalPages,
        display_max: pagination.maxPages,
        current_page: currentPage,
        callback: function(event, page) {
            if ( page ){
                pagination.currentPage = page;
                updateCollection( successCallback );
            }
        }
    });
}
</script>
{% endblock %}
