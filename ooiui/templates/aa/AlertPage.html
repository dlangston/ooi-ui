{% extends "common/base.html" %}

{% block title %}
    <title>Alerts Dashboard</title>
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="/css/compiled/index.css" type="text/css" />

  <script src="/js/partials/compiled/alertPage.js" type="text/javascript"></script>
  <script src="/js/compiled/alertPage.js" type="text/javascript"></script>
  <link href="/css/common/toc_menu.css" rel="stylesheet" type="text/css" />

  <script src="/lib/backgrid/lib/backgrid.js" type="text/javascript"></script>
  <script src="/lib/backbone-pageable/lib/backbone-pageable.min.js" type="text/javascript"></script>
  <script src="/js/core/backgrid/backgrid-paginator.min.js" type="text/javascript"></script>
  <script src="/js/core/backgrid/backgrid-select-all.min.js" type="text/javascript"></script>
  <script src="/js/core/backgrid/backgrid-filter.min.js" type="text/javascript"></script> 

  <!--
  <script src="/js/views/aa/AlertView.js" type="text/javascript"></script>
  <script src="/js/views/common/TOCView.js" type="text/javascript"></script>-->
{% endblock %}

{% block body %}
<div class="container-fluid">
  <div id="navbar" class="row"></div>
</div>

<div id="wrapper">
  <div id="page-content-wrapper">
    <div class="container-fluid">
      {% block sidebar %}
        {{ super() }}
      {% endblock %}
        <div class="col-lg-12">
          <div id="aa-panel" class="panel">
            <div id="aa-panel-body" class="panel-body">
              <div class="col-sm-12" id="toc_breadcrumb" style='font-weight:bold;padding-top:35px;'>
                <i id="current_array" style="color:#337ab7"></i>
                <i id="current_platform" style="color:#337ab7"></i>
                <i id="current_instrument" style="color:#337ab7"></i>
                <i id="current_stream" style="color:#337ab7"></i>
              </div>
              <div class="col-sm-12" id="current_array_con" style='font-weight:bold;padding-top:35px;'>
                <i id="create_aa_def_btn"></i>
              </div>

              <div style='color:#337ab7; text-transform:none; position: absolute;margin-left: -2px;' id='listTitle'>
                <b style="padding-left:15px;">Showing All</b>
              </div>
              <div id='alertslist' class="form-group">
              </div>
              <hr width ='80%' style='margin-top:0;'>
              <div class="row col-sm-12" id='alert_container'>
                <table data-toggle="table" id='alert_table' style='background-color: #fff;' data-cache="false" data-height="186">
                  <thead>
                  <tr>
                    <th data-field="id">Condition</th>
                    <th data-field="class">Operator</th>
                    <th data-field="class">Value</th>
                    <th data-field="sdate">Description</th>
                    <th data-field="sdate">Owner</th>
                    <th data-field="more">Type</th>
                    <th data-field="more">Enabled</th>
                  </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
              <hr width ='80%'>
              <div class="row col-sm-12">
                <div class="form-group">
                  <div>
                    <label class="col-sm-2" style='padding-top:18px;'>
                      Notification:
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="checkbox">
                    <label class="col-sm-2">
                      <input type="checkbox" id="Email" name="Email" checked> Email
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="checkbox">
                    <label class="col-sm-2">
                      <input type="checkbox"id="Redmine" name="Redmine"> Redmine
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="checkbox">
                    <label class="col-sm-2">
                      <input type="checkbox"id="PhoneCall" name="PhoneCall"> Phone Call
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="checkbox">
                    <label class="col-sm-2">
                      <input type="checkbox" id="TextMessage" name="TextMessage"> Text Message
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="checkbox">
                    <label class="col-sm-2">
                      <input type="checkbox" id="LogEvent" name="LogEvent"> LogEvent
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <div align="center">
                  <div>
                    <div class="col-sm-12" id="loading_alerts" style='font-weight:bold;padding-top:35px;'>
                      <i style="color:#337ab7" class="fa fa-spinner fa-spin"></i>  Loading Alerts and Alarms
                    </div>
                    <button type="button" style='display:none' id="delete_row" class="btn btn-primary"><i class="fa fa-times-circle"></i> Delete Alert Row</button>
                    <button type="button" id="newAlert" class="btn btn-primary"><i class="fa fa-plus-square"></i> Add Definition</button>
                    <!--<button type="button" id="saveAlert" class="btn btn-primary">Save Alert</button> -->
                    <button type="button" id="saveAlarm" class="btn btn-primary"><i class="fa fa-floppy-o"></i> Save Changes</button>
                    <button type="button" id="resetAlarms" class="btn btn-primary"><i class="fa fa-list"></i> Show all Alerts</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>
</div>

<!-- Menu Toggle Script -->
<script type="text/javascript">
  var bannerTitle = "Alerts & Alarms";

  var vent = _.extend({}, Backbone.Events);

  _.extend(OOI.prototype, Backbone.Events, {
    login: new LoginModel(),
    models: {
      alertModel: new AlertModel(),
      userModel: new UserModel()
    },

    collections: {
      arrays: new ArrayCollection(),
      alert_list: new AlertsFullCollection()
    },
    views: {
        //
    },
    start: function() {
      this.login.fetch({async:false});
      navbar = new NavbarView({
        login: this.login
      });

      var self = this;

      var banner = new BannerView({ bannerTitle:bannerTitle });
      $('body').prepend(banner.el);
        this.views.navbar = new NavbarView({
          el: $('#navbar')
      });
      $('#navbar-menus').append('<li id="Science"><a href="/alerts/dashboard/triggered">Triggered Alerts</a></li>');

      // render out our views:
      this.listenTo(this, 'toc:selectArray', function(options) {
        console.log('ARRAY');
        console.log(options);
        console.log(options.attributes['display_name']);
        console.log(options.attributes['array_code']);
        $('#current_array').replaceWith('<li id="current_array">' + options.attributes['display_name'] + ' (' + options.attributes['array_code'] + ')</li>');
        $('#current_platform').replaceWith('<li id="current_platform"></li>');
        $('#current_instrument').replaceWith('<li id="current_instrument"></li');
        $('#current_stream').replaceWith('<li id="current_stream"></li>');
        $('#create_aa_def_btn').replaceWith('<li id="create_aa_def_btn"></li>');
      });
      this.listenTo(this, 'toc:selectPlatform', function(options) {
        console.log('PLATFORM');
        console.log(options);
        console.log(options.attributes.assetInfo['name']);
        console.log(options.attributes['ref_des']);
        $('#current_platform').replaceWith('<li id="current_platform">' + options.attributes.assetInfo['name'] + ' (' + options.attributes['ref_des'] + ')</li>');
        $('#current_instrument').replaceWith('<li id="current_instrument"></li');
        $('#current_stream').replaceWith('<li id="current_stream"></li>');
        $('#create_aa_def_btn').replaceWith('<li id="create_aa_def_btn"></li>');
      });
      this.listenTo(this, 'toc:selectInstrument', function(options) {
        console.log(options);
        console.log(options.attributes.assetInfo['name']);
        console.log(options.attributes['ref_des']);
        $('#current_instrument').replaceWith('<li id="current_instrument">' + options.attributes.assetInfo['name'] + ' (' + options.attributes['ref_des'] + ')</li>');
        $('#current_stream').replaceWith('<li id="current_stream"></li>');
        $('#create_aa_def_btn').replaceWith('<li id="create_aa_def_btn"></li>');
      });
      this.listenTo(this, 'toc:selectStream', function(options) {
        console.log(options);
        console.log(options.model.attributes['display_name']);
        console.log(options.model.attributes['reference_designator']);
        $('#current_stream').replaceWith('<li id="current_stream">' + options.model.attributes['stream_name'] + '</li>');
        $('#create_aa_def_btn').replaceWith('<li id="create_aa_def_btn"><button type="button" id="newAlertAlarmDefinition" class="btn btn-primary"><i class="fa fa-plus-square"></i> Add Alert/Alarm Definition</button></li>');
      });

      var arrayFetch = arrayCollection.fetch({ reset: true });

      var data = {
        min : 'True'
      };

      $.when(arrayFetch).done(function() {
        var assetFetch = assetCollection.fetch({ data: data, reset: true });
        $.when(assetFetch).done(function() {
          var streamFetch = streamCollection.fetch({ data: data,  reset: true });
          $.when(streamFetch).done(function() {
            $.when( (renderTOCView( arrayCollection, assetCollection, streamCollection )) ).done(function() {
              vent.trigger('toc:cleanUp');
              vent.trigger('toc:cleanUp');
            });
          });
        });
      });

      this.listenTo(this, "login:success", this.onLogin);
      this.listenTo(this, "login:logout", this.onLogout);

      //empty table
      $('#alert_table').find('tbody').empty();

      this.views.alertFilterView = new AlertFilterView({
        collection: this.collections.alert_list
      });
    }
  });

  // controller for our model collections
  var assetCollection     = new AssetCollection();
  var arrayCollection     = new ArrayCollection();
  var streamCollection    = new StreamCollection();


  function renderTOCView( container, contents, streams ) {
    var tocView = new TOCView({
      arrayCollection:    container,
      assetCollection:    contents,
      streamCollection:   streams
    });
    tocView.render();
    // remove the spinner
    $('i#tocSpinner').remove();
    // append the toc
    $('#sidebar-wrapper').append( tocView.el );

    tocView.renderAssets();
    tocView.renderStreams();
  }

  function showSearchResults( collection ) {
    vent.trigger('toc:derenderItems');

    var searchResultView = new SearchResultView({ collection:collection });
    searchResultView.render();

    $('#assetBrowser').remove();

    $('#sidebar-wrapper').append(searchResultView.el);
  }

  function updateCollection( assetCallback ){
    var data = {
      search : $('#search-filter').val()
    };
    assetCollection.fetch({
      data : data,
      success : assetCallback
    });
  }

  var ooi = new OOI();

  $(document).ready(function() {
    $("body").tooltip({ selector: '[data-toggle=tooltip]' });
    ooi.start();
    $('#navbar').prepend(navbar.el);

    $('#search-clear').hide();

    $('#search-clear').click(function(){
      $('#search-filter').val('').focus();
      $(this).hide();
      vent.trigger('toc:derenderItems');
      var assetFetch = assetCollection.fetch();
      $.when(assetFetch).done(function() {
        $.when( (renderTOCView( arrayCollection, assetCollection, streamCollection )) ).done(function() {
          vent.trigger('toc:cleanUp');
          vent.trigger('toc:cleanUp');
        });
      });
    });

    $('#search-submit').click(function(e) {
      $('#search-clear').toggle(Boolean($(this).val()));
      $('#search-clear').toggle(Boolean($('#search-filter').val()));
      updateCollection( showSearchResults );
    });
  });

  $(document).ready(function () {
    $('label.tree-toggler').click(function () {
      $(this).parent().children('ul.tree').toggle(300);
    });
  });

</script>
{% endblock %}
